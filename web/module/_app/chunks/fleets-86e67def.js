var D=Object.defineProperty,C=Object.defineProperties;var M=Object.getOwnPropertyDescriptors;var E=Object.getOwnPropertySymbols;var N=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable;var L=(o,e,s)=>e in o?D(o,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):o[e]=s,y=(o,e)=>{for(var s in e||(e={}))N.call(e,s)&&L(o,s,e[s]);if(E)for(var s of E(e))k.call(e,s)&&L(o,s,e[s]);return o},v=(o,e)=>C(o,M(e));import{A as j}from"./base-652be6d9.js";import{w as R,t as U,a as w}from"./wallet-c826be1b.js";import{A as b,y as F}from"./config-af7f3a10.js";import{p as W}from"./privateWallet-7a0cfca0.js";import{a5 as $,F as q}from"./vendor-e78c39f1.js";import{a as x}from"./account-c0a26acd.js";import{s as P}from"./optimisticSpace-8b3fc51e.js";import{s as l}from"./spaceInfo-b394211b.js";class G extends j{async submitReveal(e,s,f,a,t,d,h,r,g,p,_,T,n){const m=R.address,i=await fetch(`${b}/account/${m}`),{account:c}=await i.json();if(!c)throw new Error(`no account registered for ${m}`);const u={player:m.toLowerCase(),fleetID:e,secret:s,from:f,to:a,distance:t,arrivalTimeWanted:d,gift:h,specific:r,potentialAlliances:g,startTime:p,minDuration:_,nonceMsTimestamp:c.nonceMsTimestamp+1,fleetSender:T,operator:n},S=`queue:${u.player}:${e}:${s}:${f.x}:${f.y}:${a.x}:${a.y}:${t}:${h}:${r}:${g?g.join(","):""}:${p}:${_}:${d}:${u.nonceMsTimestamp}`,I=await W.signer.signMessage(S),O=v(y({},u),{signature:I,delegate:W.signer.address.toLowerCase()}),A=await(await fetch(`${b}/queueReveal`,{method:"POST",body:JSON.stringify(O)})).json();if(A.error)throw A.error;return A}constructor(){super({state:"Idle"})}triggerUpdate(){this._clearTimeoutIfAny(),this._check()}acknowledgeError(){this.setPartial({error:void 0})}_onStart(){return this._stopped=!1,this._unsubscribeFromWallet=R.subscribe(this._onWallet.bind(this)),this.setPartial({state:"Loading"}),this._check(),this._stop.bind(this)}_clearTimeoutIfAny(){this._timeout&&(clearTimeout(this._timeout),this._timeout=void 0)}_stop(){this._unsubscribeFromWallet&&(this._unsubscribeFromWallet(),this._unsubscribeFromWallet=void 0),this._clearTimeoutIfAny(),this._stopped=!0}_onWallet(e){this._lastWallet!=e.address&&(this._lastWallet=e.address,this._clearTimeoutIfAny(),this._check())}async _check(){try{if(this._lastWallet){const e=await fetch(`${b}/account/${this._lastWallet}`),{account:s}=await e.json();this.setPartial({state:"Ready",account:s?{balance:$.from(s.balance),delegate:s.delegate,nonceMsTimestamp:s.nonceMsTimestamp,requireTopUp:s.requireTopUp,minimumBalance:$.from(s.minimumBalance)}:void 0})}else this.setPartial({state:"Ready",account:void 0})}catch(e){this.setPartial({state:"Loading",account:void 0}),console.error(e)}this._stopped||(this._timeout=setTimeout(this._check.bind(this),F*1e3))}}const B=new G;typeof window!="undefined"&&(window.agentService=B);class V{constructor(e){this.state={fleets:[],step:"IDLE"},this.spaceInfo=e,this.store=q(this.state,this._start.bind(this))}_start(){U.subscribe(this.onTime.bind(this)),P.subscribe(this.onSpaceUpdate.bind(this))}onTime(){for(const e of this.state.fleets){const s=l.timeToArrive(e.from,e.to),f=Math.max(s,e.arrivalTimeWanted-e.launchTime);e.timeLeft=Math.max(f-(w()-e.launchTime),0),e.timeLeft<=0&&(e.timeToResolve=Math.max(e.launchTime+f+l.resolveWindow-w(),0))}this.store.set(this.state)}onSpaceUpdate(e){this.state.fleets.length=0;let s=!1;const f=e.queryState.data?e.pendingActions:e.rawPendingActions;for(const a of f)if(a.action.type==="SEND"){const t=a.action;if(a.status!=="FAILURE"){if(a.status!=="CANCELED"){if(a.status!=="TIMEOUT"){const d=l.getPlanetInfo(t.from.x,t.from.y),h=l.getPlanetInfo(t.to.x,t.to.y);d||console.error(`not planet found at ${t.from.x}, ${t.from.y}`),h||console.error(`not planet found at ${t.to.x}, ${t.to.y}`);let r=w();t.actualLaunchTime?r=t.actualLaunchTime:a.txTimestamp?(r=a.txTimestamp,x.recordFleetLaunchTime(a.id,r)):a.final&&x.recordFleetLaunchTime(a.id,a.final);const g=l.timeToArrive(d,h),p=Math.max(g,t.arrivalTimeWanted-r),_=Math.max(p-(w()-r),0);let T=0,n="SEND_BROADCASTED";a.status==="SUCCESS"?(n="TRAVELING",_<=0&&(n="READY_TO_RESOLVE",T=Math.max(r+p+l.resolveWindow-w(),0),T<=0&&(n="TOO_LATE_TO_RESOLVE"))):a.status==="LOADING"&&(n="LOADING",s=!0);let m=!1,i;if(t.resolution){let c;for(const u of t.resolution)if(c=e.pendingActions.find(S=>S.id===u),c)break;if(!m){if(c&&(i=c,!(i.status==="FAILURE"&&i.action.acknowledged))){if(n="RESOLVE_BROADCASTED",i.status==="SUCCESS"&&i.action.acknowledged)continue;if(i.status==="SUCCESS"||i.counted){n="WAITING_ACKNOWLEDGMENT";try{console.log("WAITING_ACKNOWLEDGMENT",{tx:i.id,status:i.status,type:i.action.type,nonce:i.action.nonce,acknowledged:i.action.acknowledged,acknowledgementTime:i.action.acknowledgementTime,final:i.action.final,external:i.action.external,timestamp:i.action.timestamp})}catch(u){console.error(u)}}}m=i?i.status==="SUCCESS"&&!!i.action.acknowledged:!1}}else n==="READY_TO_RESOLVE"&&t.queueID&&l.resolveWindow-T<l.resolveWindow/72&&(n="RESOLVE_BROADCASTED");if(!m){const c=t.gift;c?t.specific==="0x0000000000000000000000000000000000000001":t.specific==="0x0000000000000000000000000000000000000001"||t.specific==="0x0000000000000000000000000000000000000000",this.state.fleets.push({txHash:a.id,from:d,to:h,duration:p,quantity:t.quantity,launchTime:r,amountDestroyed:0,timeLeft:_,timeToResolve:T,sending:a,resolution:i,state:n,gift:c,specific:t.specific,arrivalTimeWanted:t.arrivalTimeWanted,potentialAlliances:t.potentialAlliances,owner:t.fleetOwner,fleetSender:t.fleetSender,operator:t.operator})}}}}}s?(this.state.step="LOADING",console.log("still loading some fleets")):this.state.step="LOADED",this.state.fleets=this.state.fleets.sort((a,t)=>a.timeLeft-t.timeLeft),this.store.set(this.state)}subscribe(e,s){return this.store.subscribe(e,s)}}const K=new V(l);typeof window!="undefined"&&(window.fleetList=K);export{B as a,K as f};
//# sourceMappingURL=fleets-86e67def.js.map
