var E=Object.defineProperty;var S=Object.getOwnPropertySymbols;var B=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable;var b=(o,t,e)=>t in o?E(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,m=(o,t)=>{for(var e in t||(t={}))B.call(t,e)&&b(o,e,t[e]);if(S)for(var e of S(t))I.call(t,e)&&b(o,e,t[e]);return o};import{S as C,k as N,m as F}from"./config-af7f3a10.js";import{c as P,b as v,d as j,a as q,p as k}from"./privateWallet-7a0cfca0.js";import{a4 as Y,F as D,a5 as l,a6 as x,a7 as U,a8 as H,a9 as w}from"./vendor-e78c39f1.js";import{b as p}from"./paths-28a87002.js";import{i as _}from"./contracts-69d01f63.js";import{a as u,i as M}from"./wallet-c826be1b.js";class W{constructor(t){this._prefix=p&&p.startsWith("/ipfs/")||p.startsWith("/ipns/")?p.slice(6):"_c_",(async()=>{const e=await this.getItem("_version");e!==t&&(console.log("new version, clear old storage...",{lastVersion:e,version:t}),await this.clear(),t&&await this.setItem("_version",t))})()}async setItem(t,e){try{await(await this._getDB()).put("keyval",e,this._prefix+t)}catch{}}async getItem(t){try{return(await this._getDB()).get("keyval",this._prefix+t)}catch{return null}}async removeItem(t){try{await(await this._getDB()).delete("keyval",this._prefix+t)}catch{}}async clear(){try{const t=await this._getDB(),e=await t.getAllKeys("keyval");for(const s of e)if(typeof s=="string"&&s.startsWith(this._prefix))try{console.log(`removing ${s}...`),await t.delete("keyval",s)}catch{}}catch{}}_getDB(){return this._dbP||(this._dbP=Y("keyval-store",1,{upgrade(t){t.createObjectStore("keyval")}})),this._dbP}}const A=new W(_.contracts.OuterSpace.address+(_.contracts.OuterSpace.linkedData.chainGenesisHash?":"+_.contracts.OuterSpace.linkedData.chainGenesisHash:""));typeof window!="undefined"&&(window.localCache=A);const K="_account";function T(o,t){return`${K}_${o.toLowerCase()}_${t}`}class J{constructor(t,e,s,n,i,d,h,r){this.ownerAddress=t,this.chainId=e,this.syncURI=s,this.dbName=n,this.wallet=i,this.aesKey=d,this.merge=h,this._lastId=1,this.state={data:void 0,remoteFetchedAtLeastOnce:!1,remoteSyncEnabled:r},this.store=D(this.state)}subscribe(t,e){return this.store.subscribe(t,e)}_syncNow(){console.log("SYNC: _syncNow"),this._syncDelay=void 0,this._syncRemote()}_syncLater(){this._syncDelay?console.log("SYNC: _skip"):this._lastSyncTime&&performance.now()-this._lastSyncTime<1e3?this._syncDelay=setTimeout(this._syncNow.bind(this),1e3):(console.log("SYNC: _syncRemote now"),this._syncRemote())}async save(t){this.state.data=t,await this._syncLocal()||this._notify("save"),console.log("SYNC: _syncLater after save"),this._syncLater()}async requestSync(){await this._syncLocal()||this._notify("requestSync"),this._syncRemote()}async clearData(){this.state.data={},await this._saveToLocalStorage(this.ownerAddress,this.chainId,this.state.data);let t,e;try{e=(await this._fetchRemoteData()).counter}catch(s){console.error(s),t=s}t||this._postToRemote(this.state.data,e),this._notify("clearData")}async _syncRemote(){if(this._lastSyncTime=performance.now(),!this.state.remoteSyncEnabled)return;let t,e,s;try{const n=await this._fetchRemoteData();e=n.data,s=n.counter}catch(n){console.error(n),t=n}if(!t&&e){const{newData:n,newDataOnLocal:i,newDataOnRemote:d}=this.merge(this.state.data,e);d&&(this.state.data=n,await this._syncLocal()||this._notify("_syncRemote, _syncLocal")),i&&this._postToRemote(this.state.data,s),this.state.remoteFetchedAtLeastOnce=!0}}async _syncLocal(){let t=!1;const e=await this._getFromLocalStorage(),{newData:s,newDataOnLocal:n,newDataOnRemote:i}=this.merge(this.state.data,e);return this.state.data||(this.state.data=s),i&&(this.state.data=s,this._notify("_syncLocal: newDataOnRemote"),t=!0),n&&await this._saveToLocalStorage(this.ownerAddress,this.chainId,this.state.data),t}async _getFromLocalStorage(){const t=await A.getItem(T(this.ownerAddress,this.chainId));if(t)try{const e=this._decrypt(t);return JSON.parse(e)}catch(e){console.error(e)}}async _saveToLocalStorage(t,e,s){const n=JSON.stringify(s),i=this._encrypt(n);await A.setItem(T(t,e),i)}async _fetchRemoteData(){let t;try{t=await this._syncRequest("wallet_getString",[this.wallet.address,this.dbName])}catch(n){throw console.error(n),n}const e=await t.json();if(e.error)throw new Error(e.error);let s;if(e.result.data&&e.result.data!=="")try{const n=this._decrypt(e.result.data);s=JSON.parse(n)}catch(n){throw console.error(n),new Error(n)}else s={};return{data:s,counter:l.from(e.result.counter)}}async _postToRemote(t,e){const s=JSON.stringify(t),n=this._encrypt(s),i=e.add(1).toString(),d=await this.wallet.signMessage("put:"+this.dbName+":"+i+":"+n);let h,r;try{if(h=await(await this._syncRequest("wallet_putString",[this.wallet.address,this.dbName,i,n,d])).json(),h.error)throw new Error(h.error)}catch(a){r=a}if(r||h.error){console.error(r||h.error);return}if(!h.result||!h.result.success){console.error("sync no success",h);return}}async _syncRequest(t,e){return fetch(this.syncURI,{method:"POST",body:JSON.stringify({method:t,params:e,jsonrpc:"2.0",id:++this._lastId}),headers:{"Content-type":"application/json; charset=UTF-8"}})}_encrypt(t){const e=P(t),n=new x.ModeOfOperation.ctr(this.aesKey).encrypt(e);return v.bytesToBase64(n)}_decrypt(t){const e=v.base64ToBytes(t),n=new x.ModeOfOperation.ctr(this.aesKey).decrypt(e);return j(n)||""}_notify(t){console.log(`AccountDB:notify: ${t}`),this.store.set(this.state)}}function ot(o){let t,e=0;const s=o.length;return s<=34?t=l.from(o).fromTwos(128).toNumber():(t=l.from("0x"+o.slice(s-32)).fromTwos(128).toNumber(),e=l.from(o.slice(0,s-32)).fromTwos(128).toNumber()),{x:t,y:e}}function O(o,t){return U(l.from(o).toTwos(t).toHexString(),Math.floor(t/8))}function L(o,t){const e=O(o,128),s=O(t,128);return H([s,e])}function ct(o){if(!o)return{x:0,y:0,dx:0,dy:-1,index:0,data:void 0};let t=o.dx,e=o.dy;const s=o.x+t,n=o.y+e;if(s==0&&n==-1||s==n||s<0&&s==-n||s>0&&-s-1==n){const i=e;e=-t,t=i}return{index:o.index+1,x:s,y:n,dx:t,dy:e,data:void 0}}function rt(o){return`${o.x},${o.y}`}const G="0x01223334444555555666666677777777888888889999999AAAAAABBBBCCCDDEF";l.from(2);function X(o,t,e){return l.from(o).shr(t).mod(e).toNumber()}function Q(o,t){const e=X(o,t,64)+2;return l.from("0x"+G[e]).toNumber()}function dt(o,t,e){const s=Q(o,t);return l.from("0x"+e[s*4+2]+e[s*4+3]+e[s*4+4]+e[s*4+5]).toNumber()}function V(o,t){let e=!1,s=!1;const n=typeof o!="undefined",i=typeof t!="undefined";if(!(!n&&!i))if(n&&!i)e=!0;else if(!n&&i)s=!0,o=t;else{for(let d=0;d<o.length;d++)t.indexOf(o[d])===-1&&(e=!0);for(let d=0;d<t.length;d++)o.indexOf(t[d])===-1&&(s=!0,o.push(t[d]))}return{newOnLocal:e,newOnRemote:s,newArray:o}}class Z{constructor(){this.stopPrivateWalletSubscription=void 0,this.deletedPendingActions=[],this.state={step:"IDLE",data:void 0,remoteDisabledOrSynced:!1},this.store=D(this.state,this._start.bind(this))}subscribe(t,e){return this.store.subscribe(t,e)}async recordWelcomingStep(t){if(this.check(),t>32)throw new Error("bit > 32");this.state.data.welcomingStep=(this.state.data.welcomingStep||0)|Math.pow(2,t),await this.accountDB.save(this.state.data)}isWelcomingStepCompleted(t){var e;return q((e=this.state.data)==null?void 0:e.welcomingStep,t)}async recordAgentServiceDefault(t){this.check(),this.state.data.agentServiceDefault=this.state.data.agentServiceDefault||{activated:!1,timestamp:0},this.state.data.agentServiceDefault.activated=t,this.state.data.agentServiceDefault.timestamp=u(),await this.accountDB.save(this.state.data),this._notify("recordAgentServiceDefault")}isAgentServiceActivatedByDefault(){var t,e;return(e=(t=this.state.data)==null?void 0:t.agentServiceDefault)==null?void 0:e.activated}async recordCapture(t,e,s,n){this.check(),this.state.data.pendingActions[e]={type:"CAPTURE",timestamp:s,nonce:n,planetCoords:m({},t)},await this.accountDB.save(this.state.data),this._notify("recordCapture")}async hashFleet(t,e,s,n,i,d,h,r,a){const c=L(e.x,e.y),f=L(t.x,t.y),y=w(["bytes32","uint256","uint256"],[k.hashString(),f,d]),g=w(["bytes32","uint256","bool","address","uint256"],[y,c,s,n,i]),R=w(["bytes32","uint256","address","address"],[g,f,r||h,a||h]);return{toHash:g,fleetId:R,secretHash:y}}async recordFleet(t,e,s,n,i){this.check(),this.state.data.pendingActions[e]={fleetId:t.id,timestamp:s,nonce:n,type:"SEND",from:m({},t.from),to:m({},t.to),gift:t.gift,specific:t.specific,potentialAlliances:t.potentialAlliances?[...t.potentialAlliances]:void 0,quantity:t.fleetAmount,arrivalTimeWanted:t.arrivalTimeWanted,fleetSender:t.fleetSender,operator:t.operator,fleetOwner:t.owner,overrideTimestamp:i},await this.accountDB.save(this.state.data),this._notify("recordFleet")}async recordFleetLaunchTime(t,e){this.check();const s=this.state.data.pendingActions[t];s&&typeof s!="number"&&s.actualLaunchTime!==e&&(s.actualLaunchTime=e,await this.accountDB.save(this.state.data))}async recordFleetResolvingTxhash(t,e,s,n,i,d,h){this.check(),this.state.data.pendingActions[e].resolution=[s],this.state.data.pendingActions[s]={type:"RESOLUTION",timestamp:i,nonce:d,to:n,fleetId:t},await this.accountDB.save(this.state.data),this._notify("recordFleetResolvingTxhash")}async recordExternalResolution(t,e,s,n){var r,a;this.check();const i=this.state.data.pendingActions[t];if(typeof i=="number")return;let d=!1;i.resolution?i.resolution.indexOf(s)===-1&&(i.resolution.push(s),d=!0):(i.resolution=[s],d=!0);const h=this.state.data.pendingActions[s];if(typeof h!="number")if(h)(!((r=h.external)==null?void 0:r.final)||((a=h.external)==null?void 0:a.final)<n)&&(h.external={status:"SUCCESS",final:n},d=!0);else{const c={type:"RESOLUTION",external:{status:"SUCCESS",final:n},timestamp:n,to:e,nonce:0,fleetId:s};this.state.data.pendingActions[s]=c,d=!0}d&&(await this.accountDB.save(this.state.data),this._notify("recordExternalResolution"))}async recordExit(t,e,s,n){this.check(),this.state.data.pendingActions[e]={type:"EXIT",timestamp:s,nonce:n,planetCoords:t},await this.accountDB.save(this.state.data),this._notify("recordExit")}async deletePendingAction(t){this.check(),this.deletedPendingActions.indexOf(t)===-1&&this.deletedPendingActions.push(t),delete this.state.data.pendingActions[t],await this.accountDB.save(this.state.data),this._notify("deletePendingAction")}async cancelActionAcknowledgment(t){this.check();const e=this.state.data.pendingActions[t];e&&typeof e!="number"&&(e.acknowledged=void 0,e.acknowledgementTime=u(),await this.accountDB.save(this.state.data),this._notify("cancelActionAcknowledgment"))}getAcknowledgement(t){var e,s;return((e=this.state.data)==null?void 0:e.acknowledgements)&&((s=this.state.data)==null?void 0:s.acknowledgements[t])}getPendingAction(t){var e,s;return((e=this.state.data)==null?void 0:e.pendingActions)&&((s=this.state.data)==null?void 0:s.pendingActions[t])}getSendActionFromFleetId(t){var e,s,n;if(!!((e=this.state.data)==null?void 0:e.pendingActions))for(const i of Object.keys((s=this.state.data)==null?void 0:s.pendingActions)){const d=(n=this.state.data)==null?void 0:n.pendingActions[i];if(d&&typeof d!="number"&&d.type==="SEND"&&d.fleetId===t)return d}}async acknowledgeEvent(t){var i;this.check();const e=t.id;let s;t.type==="external_fleet_arrived"||t.type==="internal_fleet_arrived"?s=t.event.planetLoss+":"+t.event.fleetLoss+":"+t.event.won:t.type==="external_fleet_sent"?s=""+t.event.quantity:t.type==="exit_complete"&&(s=`${t.interupted}`);const n=(i=this.state.data)==null?void 0:i.acknowledgements[e];n?n.stateHash!==s&&(n.timestamp=u(),n.stateHash=s,await this.accountDB.save(this.state.data),this._notify("acknowledgeEvent changed")):(this.state.data.acknowledgements[e]={timestamp:u(),stateHash:s},await this.accountDB.save(this.state.data),this._notify("acknowledgeEvent new"))}async acknowledgeSuccess(t,e,s){return this.acknowledgeAction("SUCCESS",t,e,s)}async acknowledgeError(t,e,s){return this.acknowledgeAction("ERROR",t,e,s)}async acknowledgeAction(t,e,s,n){this.check();const i=this.state.data.pendingActions[e];i&&typeof i!="number"&&(n?this.state.data.pendingActions[e]=n:(i.acknowledged=t,i.acknowledgementTime=u()),await this.accountDB.save(this.state.data),this._notify("acknowledgeAction"))}async recordTxActionAsFinal(t,e,s){this.check();const n=this.state.data.pendingActions[t];n&&typeof n!="number"&&!n.final&&(n.final={timestamp:s,status:e},await this.accountDB.save(this.state.data),this._notify("recordTxActionAsFinal"))}async markAsFullyAcknwledged(t,e){this.check();const s=this.state.data.pendingActions[t];s&&typeof s!="number"&&(this.state.data.pendingActions[t]=e,await this.accountDB.save(this.state.data),this._notify("markAsFullyAcknwledged"))}async recordQueueID(t,e){this.check();const s=this.state.data.pendingActions[t];s&&typeof s!="number"&&s.queueID!==e&&(s.queueID=e,await this.accountDB.save(this.state.data),this._notify("recordQueueID"))}check(){if(!this.state.data)throw new Error("Account not ready yet")}isReady(){return!!this.state.data}_start(){return this.stopPrivateWalletSubscription=k.subscribe(async t=>{await this._handlePrivateWalletChange(t)}),this._stop.bind(this)}async _handlePrivateWalletChange(t){if(t.step!=="READY"){this.unsubscribeFromSync&&(this.unsubscribeFromSync(),this.unsubscribeFromSync=void 0),this.state.step="IDLE",this.state.data=void 0,this.state.ownerAddress=t.ownerAddress,this._notify("_handlePrivateWalletChange not READY");return}(!this.accountDB||t.ownerAddress!==this.accountDB.ownerAddress||t.chainId!==this.accountDB.chainId)&&(this.unsubscribeFromSync&&(this.unsubscribeFromSync(),this.unsubscribeFromSync=void 0),this.state.step="IDLE",this.state.data=void 0,this.state.ownerAddress=t.ownerAddress,this._notify("_handlePrivateWalletChange READY"),t.ownerAddress&&(this.accountDB=new J(t.ownerAddress,t.chainId,C,N,t.signer,t.aesKey,this._merge.bind(this),t.syncEnabled),this.unsubscribeFromSync=this.accountDB.subscribe(this.onSync.bind(this)),console.log("SYNC: requesting sync after account changed"),this.accountDB.requestSync()))}onSync(t){this.state.syncError=t.error,this.state.data=t.data,this.state.remoteDisabledOrSynced=t.remoteFetchedAtLeastOnce||!t.remoteSyncEnabled,this.state.data?this.state.step="READY":this.state.step="IDLE",this._notify("onSync")}_merge(t,e){let s=!1,n=!1,i=t;i||(i={pendingActions:{},welcomingStep:0,acknowledgements:{}}),e||(e={pendingActions:{},welcomingStep:0,acknowledgements:{}});for(const r of this.deletedPendingActions)e.pendingActions[r]&&(delete e.pendingActions[r],s=!0),i.pendingActions[r]&&(delete i.pendingActions[r],s=!0);if(e.welcomingStep>i.welcomingStep?(n=!0,i.welcomingStep=i.welcomingStep|e.welcomingStep):(!e.welcomingStep||i.welcomingStep>e.welcomingStep)&&(s=!0),e.agentServiceDefault&&!i.agentServiceDefault?(n=!0,i.agentServiceDefault=e.agentServiceDefault):!e.agentServiceDefault&&i.agentServiceDefault?s=!0:e.agentServiceDefault&&i.agentServiceDefault&&(e.agentServiceDefault.timestamp>i.agentServiceDefault.timestamp?(n=!0,i.agentServiceDefault=e.agentServiceDefault):e.agentServiceDefault.timestamp<i.agentServiceDefault.timestamp&&(s=!0)),e.pendingActions){for(const r of Object.keys(e.pendingActions)){const a=e.pendingActions[r],c=i.pendingActions[r];if(!c)i.pendingActions[r]=a,n=!0;else if(typeof c=="number"&&typeof a!="number")a.overrideTimestamp&&a.overrideTimestamp>c?(n=!0,i.pendingActions[r]=a):s=!0;else if(typeof c!="number"&&typeof a=="number")c.overrideTimestamp&&c.overrideTimestamp>a?s=!0:(n=!0,i.pendingActions[r]=a);else if(typeof c!="number"&&typeof a!="number"&&(c.acknowledged!==a.acknowledged&&(!a.acknowledgementTime||c.acknowledgementTime&&c.acknowledgementTime>=a.acknowledgementTime?s=!0:(n=!0,c.acknowledged=a.acknowledged,c.acknowledgementTime=a.acknowledgementTime)),c.final&&!a.final?s=!0:!c.final&&a.final&&(n=!0,c.final=a.final),c.external&&!a.external?s=!0:!c.external&&a.external&&(n=!0,c.external=a.external),c.type==="SEND"&&a.type==="SEND")){const{newOnLocal:f,newOnRemote:y,newArray:g}=V(c.resolution,a.resolution);f&&(s=!0),y&&(c.resolution=g,n=!0),c.actualLaunchTime&&!a.actualLaunchTime?s=!0:!c.actualLaunchTime&&a.actualLaunchTime&&(n=!0,c.actualLaunchTime=a.actualLaunchTime),c.queueID&&!a.queueID?s=!0:!c.queueID&&a.queueID&&(n=!0,c.queueID=a.queueID)}}for(const r of Object.keys(i.pendingActions))e.pendingActions[r]||(s=!0)}else s=!0;const d=[],h=M()?u():void 0;if(h){for(const r of Object.keys(i.pendingActions)){const a=i.pendingActions[r];typeof a=="number"&&h-a>F&&(d.push(r),s=!0,e.pendingActions[r]||(n=!0))}if(d.length>0){console.log(`deleting ${d.length} expired actions`);for(const r of d)delete i.pendingActions[r]}}if(e.acknowledgements){for(const r of Object.keys(e.acknowledgements)){const a=e.acknowledgements[r],c=i.acknowledgements[r];c?typeof c=="number"&&typeof a!="number"?s=!0:typeof c!="number"&&typeof a=="number"?(n=!0,i.pendingActions[r]=a):typeof c!="number"&&typeof a!="number"&&c.timestamp!==a.timestamp&&(c.timestamp>a.timestamp?s=!0:(n=!0,c.timestamp=a.timestamp,c.stateHash=a.stateHash)):(i.acknowledgements[r]=a,n=!0)}for(const r of Object.keys(i.acknowledgements))e.acknowledgements[r]||(s=!0)}else s=!0;return{newData:i,newDataOnLocal:s,newDataOnRemote:n}}_stop(){this.stopPrivateWalletSubscription&&(this.stopPrivateWalletSubscription(),this.stopPrivateWalletSubscription=void 0)}_notify(t){console.log(`notify: ${t}`),this.store.set(this.state)}generateError(){throw new Error("error on version: 817e8fe")}}const $=new Z;typeof window!="undefined"&&(window.account=$);export{$ as a,dt as b,ct as c,rt as d,ot as l,Q as n,X as v,L as x};
//# sourceMappingURL=account-c0a26acd.js.map
