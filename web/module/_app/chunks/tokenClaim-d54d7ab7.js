import{p as X}from"./planets-78a3d361.js";import{p as A}from"./playersQuery-3a795d59.js";import{s as y}from"./spaceInfo-b394211b.js";import{F as G,G as M,a5 as _,aJ as Et,aK as Dt,af as xt,aL as Rt}from"./vendor-e78c39f1.js";import{l as Ft,a as S,x as L}from"./account-c0a26acd.js";import{w as h,i as Pt,e as It,a as st,c as Mt}from"./wallet-c826be1b.js";import{p as Tt,f as b}from"./privateWallet-7a0cfca0.js";import{B as Y,b as U}from"./base-652be6d9.js";import{T as V}from"./myprofile-37a6a38f.js";import{a as _t,f as Ut}from"./fleets-86e67def.js";import{s as Ct}from"./optimisticSpace-8b3fc51e.js";import{u as Q,v as Wt}from"./config-af7f3a10.js";import{S as Ht}from"./subgraph-aa394bde.js";import{i as Gt}from"./contracts-69d01f63.js";const k=class{constructor(r,t=4){this.randseed=[0,0,0,0],this.scale=t,this.size=8,this.seedrand(r),this.color=this.createColor(),this.bgcolor=this.createColor(),this.spotcolor=this.createColor(),this.imageData=this.createImageData(this.size)}static get(r,t=0){const e=r.toLowerCase()+"_"+t;return k.blockiesCache[e]||(k.blockiesCache[e]=new k(r,1)),k.blockiesCache[e]}static getURI(r,t=0){if(typeof document=="undefined")return"";const e=r.toLowerCase()+"_"+t;if(!k.blockieStringsCache[e]){const s=k.get(r),a=document.createElement("canvas");a.width=8+t*2,a.height=8+t*2;const i=a.getContext("2d");s.draw(i,0,0,1,{offset:t}),k.blockieStringsCache[e]=a.toDataURL()}return k.blockieStringsCache[e]}draw(r,t,e,s,a){const i=r.fillStyle,o=this.scale*s,l=this.size*o;(a==null?void 0:a.border)===1&&(r.strokeStyle="green",r.lineWidth=o,r.setLineDash([]),r.strokeRect(Math.floor(t-o),Math.floor(e-o),Math.floor(l+o*2),Math.floor(l+o*2))),r.fillStyle=this.bgcolor,(a==null?void 0:a.offset)?(r.fillRect(Math.floor(t),Math.floor(e),Math.floor(l+a.offset*2),Math.floor(l+a.offset*2)),t+=a.offset,e+=a.offset):r.fillRect(Math.floor(t),Math.floor(e),Math.floor(l),Math.floor(l));for(let d=0;d<this.imageData.length;d++){const c=Math.floor(d/this.size),n=d%this.size;r.fillStyle=this.imageData[d]==1?this.color:this.spotcolor,this.imageData[d]!=0&&r.fillRect(Math.floor(t+n*o),Math.floor(e+c*o),Math.ceil(o),Math.ceil(o))}r.fillStyle=i}seedrand(r){for(let t=0;t<this.randseed.length;t++)this.randseed[t]=0;for(let t=0;t<r.length;t++)this.randseed[t%4]=(this.randseed[t%4]<<5)-this.randseed[t%4]+r.charCodeAt(t)}rand(){const r=this.randseed[0]^this.randseed[0]<<11;return this.randseed[0]=this.randseed[1],this.randseed[1]=this.randseed[2],this.randseed[2]=this.randseed[3],this.randseed[3]=this.randseed[3]^this.randseed[3]>>19^r^r>>8,(this.randseed[3]>>>0)/(1<<31>>>0)}createColor(){const r=Math.floor(this.rand()*360),t=Math.floor(1e3*(this.rand()*60+40))/1e3+"%",e=Math.floor(1e3*(this.rand()+this.rand()+this.rand()+this.rand())*25)/1e3+"%";return"hsl("+r+","+t+","+e+")"}hue2rgb(r,t,e){return e<0&&(e+=1),e>1&&(e-=1),e<1/6?r+(t-r)*6*e:e<1/2?t:e<2/3?r+(t-r)*(2/3-e)*6:r}createImageData(r){const t=r,e=r,s=Math.ceil(t/2),a=t-s,i=[];for(let o=0;o<e;o++){let l=[];for(let c=0;c<s;c++)l[c]=Math.floor(this.rand()*2.3);const d=l.slice(0,a);d.reverse(),l=l.concat(d);for(let c=0;c<l.length;c++)i.push(l[c])}return i}};let At=k;At.blockiesCache={};At.blockieStringsCache={};class Bt extends Y{constructor(){super(void 0)}select(t,e){this.set({x:t,y:e})}selectViaId(t){this.set(Ft(t))}unselect(){this.set(void 0)}}var Ot=new Bt;const at=G(void 0);let x,W,rt;Ot.subscribe(r=>{if(!r)x&&(x(),x=void 0),W=void 0,rt=void 0,at.set(void 0);else{const t=y.getPlanetInfo(r.x,r.y);t.location.id!==(W==null?void 0:W.location.id)&&(x&&(x(),x=void 0),W=t,rt=X.planetStateFor(W),x=rt.subscribe(e=>{e&&e.owner&&e.owner!="0x0000000000000000000000000000000000000000"?at.set(A.getPlayer(e.owner)):at.set(void 0)}))}});const B=[],H=G([]),Ce={subscribe:H.subscribe.bind(H)};function qt(r,t,e,s){for(const a of e)if(a.action===t){r.push({src:s,title:a.title,panelConditions:a.panelConditions,mapConditions:a.mapConditions});break}}function $t(r,t){const e=r.findIndex(s=>s.src===t);e>=0&&r.splice(e,1)}function kt(r,t){var e,s,a,i;if(r==="owner")return((e=t.account)==null?void 0:e.toLowerCase())===((a=(s=t.planetState)==null?void 0:s.owner)==null?void 0:a.toLowerCase());if(r.startsWith("planet")){const o=r.split(":");return((i=t.planetState)==null?void 0:i.metadata[o[1]])!==void 0}}function Ae(r,t){for(const e of r)if(typeof e=="string"){if(kt(e,t))return!0}else{for(const s of e)if(!kt(s,t))return!1;return!0}return!1}const z=G(void 0);let J,Z;const jt={subscribe:z.subscribe.bind(z),showPlanet(r,t,e){const s=B.find(i=>i.src===r);z.set(r);function a(){s.window.postMessage(JSON.stringify({type:"show_planet",planet:{info:e,state:M(t)},account:M(S).ownerAddress}),s.src)}a(),J=t.subscribe(i=>{a()}),Z=S.subscribe(i=>{a()})},hide(){J&&(J(),J=void 0),Z&&(Z(),Z=void 0),z.set(void 0)}};function Oe(r,t,e){if(B.find(a=>a.src===r))console.error(`plugin with src ${r} already registered`);else if(B.push({src:r,window:t,config:e}),e){const a=M(H);qt(a,"show_planet",e.actions,r),H.set(a)}}function ke(r){const t=B.findIndex(e=>e.src===r);if(t>=0){const e=M(H);$t(e,r),H.set(e),B.splice(t,1)}else console.error(`no plugin with src ${r} found`)}typeof window!="undefined"&&(window.pluginShowing=jt);function Le(r,t){return{from:y.getPlanetInfo(t.x,t.y),to:y.getPlanetInfo(r.to.x,r.to.y)}}function be(r,t){return{from:y.getPlanetInfo(r.from.x,r.from.y),to:y.getPlanetInfo(t.x,t.y)}}function Lt(r,t){const e=[];for(const s of r)t.indexOf(s)!==-1&&e.push(s);return e}class Kt extends U{constructor(){super({type:"SEND",step:"IDLE",pastStep:"IDLE"})}isGift(){var t;return((t=this.$store.data)==null?void 0:t.gift)||!1}async sendFrom(t,e){this.$store.step=="PICK_ORIGIN"?this.pickOrigin(t,e):(await Tt.login(),e?this.setData({from:t,config:e},{step:"PICK_DESTINATION",pastStep:"PICK_DESTINATION",cancelingConfirmation:void 0}):this.setData({from:t},{step:"PICK_DESTINATION",pastStep:"PICK_DESTINATION",cancelingConfirmation:void 0}))}async sendToInactivePlanet(t){this.setData({to:t},{step:"INACTIVE_PLANET",cancelingConfirmation:void 0})}async sendTo(t){this.$store.step=="PICK_DESTINATION"?this.pickDestination(t):(await Tt.login(),this.setData({to:t},{step:"PICK_ORIGIN",pastStep:"PICK_ORIGIN",cancelingConfirmation:void 0}))}async pickDestination(t){if(this.$store.step!=="PICK_DESTINATION")throw new Error("Need to be in step PICK_DESTINATION");this.setData({to:t}),this._chooseFleetAmount()}async pickOrigin(t,e){if(this.$store.step!=="PICK_ORIGIN")throw new Error("Need to be in step PICK_ORIGIN");e?this.setData({from:t,config:e}):this.setData({from:t}),this._chooseFleetAmount()}async _chooseFleetAmount(){const t=this.setPartial({step:"CREATING_TX"});if(t.data){const e=t.data.to,s=y.getPlanetInfo(e.x,e.y),a=M(X.planetStateFor(s));if(a.owner)if(a.owner===h.address.toLowerCase())this.setData({gift:!0});else{await A.triggerUpdate();const i=A.getPlayer(h.address.toLowerCase()),o=A.getPlayer(a.owner);i&&i.alliances.length>0&&o&&o.alliances.length>0&&Lt(i.alliances.map(d=>d.address),o.alliances.map(d=>d.address)).length>0&&this.setData({gift:!0})}}S.isWelcomingStepCompleted(V.TUTORIAL_FLEET_AMOUNT)?this.setPartial({step:"CHOOSE_FLEET_AMOUNT"}):this.setPartial({step:"TUTORIAL_PRE_FLEET_AMOUNT"})}async acknowledgeWelcomingStep1(){S.recordWelcomingStep(V.TUTORIAL_FLEET_AMOUNT),this._chooseFleetAmount()}confirm(t,e,s,a,i,o){this.setData({fleetAmount:t,gift:e,useAgentService:s,config:{fleetOwner:a,arrivalTimeWanted:i},force:o}),S.isWelcomingStepCompleted(V.TUTORIAL_FLEET_PRE_TRANSACTION)?this._confirm(t,e,s,o):this.setPartial({step:"TUTORIAL_PRE_TRANSACTION"})}async acknowledgeWelcomingStep2(){var t,e,s,a,i,o,l,d,c,n;if(!((t=this.$store.data)==null?void 0:t.fleetAmount))throw new Error("not fleetAmount recorded");if(((e=this.$store.data)==null?void 0:e.gift)===void 0)throw new Error("not gift recorded");S.recordWelcomingStep(V.TUTORIAL_FLEET_PRE_TRANSACTION),this.confirm((s=this.$store.data)==null?void 0:s.fleetAmount,(a=this.$store.data)==null?void 0:a.gift,(i=this.$store.data)==null?void 0:i.useAgentService,(l=(o=this.$store.data)==null?void 0:o.config)==null?void 0:l.fleetOwner,(c=(d=this.$store.data)==null?void 0:d.config)==null?void 0:c.arrivalTimeWanted,(n=this.$store.data)==null?void 0:n.force)}async _confirm(t,e,s,a){var dt,ht,ft,ut,pt,mt,gt,wt,vt,yt,St;const i=this.setPartial({step:"CREATING_TX",cancelingConfirmation:void 0});if(!i.data)throw new Error("no data for send flow");const o=i.data.from,l=i.data.to,d=y.getPlanetInfo(o.x,o.y),c=y.getPlanetInfo(l.x,l.y);if(!d||!c)throw new Error("cannot get to or from planet info");if(!h.address)throw new Error("no wallet address");if(!h.provider)throw new Error("no provider");const n=((dt=i.data.config)==null?void 0:dt.pricePerUnit)?_.from((ht=i.data.config)==null?void 0:ht.pricePerUnit):void 0,p=h.address.toLowerCase(),v=((ft=i.data.config)==null?void 0:ft.fleetOwner)||p,w=((ut=i.data.config)==null?void 0:ut.fleetSender)||p,f=(pt=i.data.config)==null?void 0:pt.msgValue,u=((mt=i.data.config)==null?void 0:mt.contractAddress)||p,E=((gt=i.data.config)==null?void 0:gt.arrivalTimeWanted)||0;let P;try{P=await h.provider.getBlock("latest")}catch(m){this.setPartial({step:"CHOOSE_FLEET_AMOUNT",error:m});return}Pt||It(P.timestamp);let T="0x0000000000000000000000000000000000000001",C=[];const R=M(X.planetStateFor(c));let g;if(R.owner){try{await A.triggerUpdate()}catch(D){this.setPartial({step:"CHOOSE_FLEET_AMOUNT",error:D});return}const m=A.getPlayer(v);g=A.getPlayer(R.owner),console.log({me:m,destinationOwner:g}),m&&m.alliances.length>0&&g&&g.alliances.length>0&&(C=Lt(m.alliances.map(D=>D.address),g.alliances.map(D=>D.address)))}g&&!e&&g.address===p?T="0x0000000000000000000000000000000000000000":(g&&!e&&C.length>0||g&&e&&C.length==0)&&(T=g.address);let N;try{N=await h.provider.getTransactionCount(p)}catch(m){this.setPartial({step:"CHOOSE_FLEET_AMOUNT",error:m});return}const nt=y.distance(d,c),ot=y.timeToArrive(d,c),{toHash:q,fleetId:$,secretHash:et}=await S.hashFleet(o,l,e,T,E,N,v,w,u);console.log({from:o,to:l,gift:e,specific:T,arrivalTimeWanted:E,nonce:N,fleetOwner:v,fleetSender:w,operator:u,toHash:q,fleetId:$,secretHash:et});const ct=void 0,F=(wt=i.data.config)==null?void 0:wt.abi,I=(vt=i.data.config)==null?void 0:vt.args;if(I)for(let m=0;m<I.length;m++)I[m]==="{numSpaceships}"?I[m]=i.data.fleetAmount:I[m]==="{toHash}"?I[m]=q:I[m]==="{numSpaceships*pricePerUnit}"?I[m]=n.mul(i.data.fleetAmount):I[m]==="{fleetOwner}"&&(I[m]=v);let j=_.from(0);f==="{numSpaceships*pricePerUnit}"?j=n.mul(i.data.fleetAmount):f&&(j=_.from(f));let K;if(a)K=_.from(2e6);else try{F?K=await new Et(u,[F],h.provider.getSigner()).estimateGas[F.name](...I,{value:j}):K=await((yt=h.contracts)==null?void 0:yt.OuterSpace.estimateGas.sendFor({fleetSender:w,fleetOwner:v,from:L(o.x,o.y),quantity:t,toHash:q}))}catch(m){this.setPartial({step:"CHOOSE_FLEET_AMOUNT",error:m});return}const lt=K.add(1e5);this.setPartial({step:"WAITING_TX",lastFleet:{fleet:{id:$,to:l,from:o,fleetAmount:t,arrivalTimeWanted:E,gift:e,specific:T,potentialAlliances:C,owner:v,fleetSender:w,operator:u},timestamp:P.timestamp,nonce:N,useAgentService:s,extra:{secretHash:et,distance:nt,minDuration:ot}}});let O;try{F?O=await new Et(u,[F],h.provider.getSigner())[F.name](...I,{nonce:N,gasPrice:ct,value:j,gasLimit:lt}):O=await((St=h.contracts)==null?void 0:St.OuterSpace.sendFor({fleetSender:w,fleetOwner:v,from:L(o.x,o.y),quantity:t,toHash:q},{nonce:N,gasPrice:ct,gasLimit:lt}))}catch(m){if(m.transactionHash){O={hash:m.transactionHash};try{O=await h.provider.getTransaction(m.transactionHash)}catch{console.log("could not fetch tx, to get the nonce")}}if(!O||!O.hash){if(console.error(m),m.message&&m.message.indexOf("User denied")>=0){this.setPartial({step:"IDLE",error:void 0});return}this.setPartial({error:m,step:"CHOOSE_FLEET_AMOUNT"});return}}if(S.recordFleet({id:$,to:l,from:o,fleetAmount:t,arrivalTimeWanted:E,gift:e,specific:T,potentialAlliances:C,owner:v,fleetSender:w,operator:u},O.hash,P.timestamp,N),this.setData({txHash:O.hash},{step:"SUCCESS"}),s)try{const{queueID:m}=await _t.submitReveal($,et,o,l,nt,E,e,T,C,P.timestamp,ot,w,u);S.recordQueueID(O.hash,m)}catch(m){this.setPartial({error:{message:b(m),type:"AGENT_SERVICE_SUBMISSION_ERROR"}})}}async cancelCancelation(){this.setPartial({cancelingConfirmation:!1})}async recoverFleetFromTxHash(t){if(!t){this.setPartial({error:{message:"no tx hash specified"}});return}const e=await h.provider.getTransaction(t);if(!e||!e.hash){this.setPartial({error:{message:`no tx found with hash : ${t}`}});return}const s=this.$store.lastFleet;if(s&&(console.log({lastFleet:s}),S.recordFleet(s.fleet,e.hash,s.timestamp,s.nonce),this.setData({txHash:t},{step:"SUCCESS",cancelingConfirmation:!1}),s.useAgentService))try{const{queueID:a}=await _t.submitReveal(s.fleet.id,s.extra.secretHash,s.fleet.from,s.fleet.to,s.extra.distance,s.fleet.arrivalTimeWanted,s.fleet.gift,s.fleet.specific,s.fleet.potentialAlliances,s.timestamp,s.extra.minDuration,s.fleet.fleetSender,s.fleet.operator);S.recordQueueID(t,a)}catch(a){this.setPartial({error:{message:b(a),type:"AGENT_SERVICE_SUBMISSION_ERROR"}})}}async cancel(t=!1){t?this.setPartial({cancelingConfirmation:!0}):this._reset()}async back(){this.$store.pastStep==="PICK_DESTINATION"?this.setData({to:void 0}):this.$store.pastStep==="PICK_ORIGIN"&&this.setData({from:void 0}),this.setPartial({step:this.$store.pastStep})}async acknownledgeSuccess(){this._reset()}async acknownledgeError(){this.setPartial({error:void 0})}_reset(){this.setPartial({step:"IDLE",data:void 0})}}const Xt=new Kt;typeof window!="undefined"&&(window.sendFlow=Xt);class Yt extends Y{constructor(){super(void 0)}select(t){this.set(t)}unselect(){this.set(void 0)}}const Vt=new Yt;typeof window!="undefined"&&(window.fleetselection=Vt);class Qt{constructor(t){this.events=[],this.tmpEvents=[],this.spaceInfo=t,this.store=G(this.events),Ct.subscribe(this.onSpaceUpdate.bind(this)),S.subscribe(this._handleAccountChange.bind(this))}onSpaceUpdate(t){var a,i,o,l,d,c;const e=[];if((a=t.queryState.data)==null?void 0:a.fleetsArrivedFromYou){for(const n of t.queryState.data.fleetsArrivedFromYou)e.push({type:"internal_fleet_arrived",event:n,effect:n.operator!==n.sender.id?n.destinationOwner.id===((i=this.currentOwner)==null?void 0:i.toLowerCase())?n.gift?"good":"bad":"neutral":n.won||n.gift?"good":"neutral",id:_.from(n.fleet.id).toHexString(),location:n.planet.id});for(const n of t.queryState.data.fleetsArrivedToYou)e.push({type:"external_fleet_arrived",effect:n.gift?"good":"bad",event:n,id:_.from(n.fleet.id).toHexString(),location:n.planet.id});for(const n of t.queryState.data.fleetsArrivedAsYou)e.push({type:"external_fleet_arrived",effect:n.gift?"good":"bad",event:n,id:_.from(n.fleet.id).toHexString(),location:n.planet.id});for(const n of t.queryState.data.fleetsSentExternally)e.push({type:"external_fleet_sent",effect:"neutral",event:n,id:"sent_"+_.from(n.fleet.id).toHexString(),location:n.planet.id})}if((o=t.queryState.data)==null?void 0:o.planetTimePassedExitEvents)for(const n of t.queryState.data.planetTimePassedExitEvents)e.push({type:"exit_complete",location:n.planet.id,id:n.planet.id,effect:"good",event:n,interupted:!1});if((l=t.queryState.data)==null?void 0:l.planetInteruptedExitEvents)for(const n of t.queryState.data.planetInteruptedExitEvents)e.push({type:"exit_complete",location:n.planet.id,id:n.planet.id,event:n,effect:"bad",interupted:!0});const s=(c=(d=t.queryState.data)==null?void 0:d.player)==null?void 0:c.id;this.currentOwner!==s?(this.tmpPlayer=s,this.tmpEvents=e,this.events.length=0):this.events=this.addAcknowledgements(e),this.store.set(this.events)}addAcknowledgements(t){for(const e of t){const s=e.id,a=this.acknowledgements&&this.acknowledgements[s];if(!a)e.acknowledged="NO";else{let i;e.type==="internal_fleet_arrived"||e.type==="external_fleet_arrived"?i=e.event.planetLoss+":"+e.event.fleetLoss+":"+e.event.won:e.type==="external_fleet_sent"?i=""+e.event.quantity:e.type==="exit_complete"&&(i=`${e.interupted}`),a.stateHash!==i?e.acknowledged="UPDATED_SINCE":e.acknowledged="YES"}}return t.filter(e=>e.acknowledged!=="YES").sort((e,s)=>e.event.timestamp-s.event.timestamp)}async _handleAccountChange(t){var s,a,i;const e=(s=t.ownerAddress)==null?void 0:s.toLowerCase();this.acknowledgements=(a=t.data)==null?void 0:a.acknowledgements,this.pendingActions=(i=t.data)==null?void 0:i.pendingActions,t.step==="IDLE"?(this.currentOwner=void 0,this.events=[]):this.currentOwner===e?this.events=this.addAcknowledgements(this.events):e===this.tmpPlayer?(this.currentOwner=e,this.events=this.addAcknowledgements(this.tmpEvents)):(this.currentOwner=e,this.events=[]),this.store.set(this.events)}subscribe(t,e){return this.store.subscribe(t,e)}}const zt=new Qt(y);typeof window!="undefined"&&(window.myevents=zt);class Jt{constructor(){this.errors=[],this.tmpErrors=[],this.store=G(this.errors,this._start.bind(this))}_start(){Ct.subscribe(this.onSpaceUpdate.bind(this)),S.subscribe(this._handleAccountChange.bind(this))}onSpaceUpdate(t){var a,i;const e=[];for(const o of t.pendingActions){let l=!1,d;if(o.action.type==="SEND"){d=o.action.from;let c;const n=o.action;if(n.resolution){for(const p of n.resolution)if(c=t.pendingActions.find(v=>v.id===p),c)break}if(!c){const p=y.getPlanetInfo(n.from.x,n.from.y),v=y.getPlanetInfo(n.to.x,n.to.y),w=y.timeToArrive(p,v);if(n.actualLaunchTime){const f=Math.max(w,n.arrivalTimeWanted-n.actualLaunchTime),u=n.actualLaunchTime,E=Math.max(f-(st()-u),0);let P=0;o.status==="SUCCESS"&&E<=0&&(P=Math.max(u+f+y.resolveWindow-st(),0),P<=0&&(l=!0,d=o.action.to,e.push({action:o.action,status:"TIMEOUT",txHash:o.id,location:d,acknowledged:o.action.acknowledged==="ERROR",late:!0})))}}}else o.action.type==="CAPTURE"?d=o.action.planetCoords:o.action.type==="RESOLUTION"?d=o.action.to:o.action.type==="EXIT"&&(d=o.action.planetCoords);!l&&(o.status==="FAILURE"||o.status==="CANCELED"||o.status==="TIMEOUT")&&e.push({action:o.action,status:o.status,txHash:o.id,location:d,acknowledged:o.action.acknowledged==="ERROR"})}const s=(i=(a=t.queryState.data)==null?void 0:a.player)==null?void 0:i.id;this.currentOwner!==s?(this.tmpPlayer=s,this.tmpErrors=e,this.errors.length=0):this.errors=this.addAcknowledgements(e),this.store.set(this.errors)}addAcknowledgements(t){for(const e of t){const s=this.pendingActions&&this.pendingActions[e.txHash]||e.action;e.acknowledged=typeof s=="number"||(s==null?void 0:s.acknowledged)==="ERROR"}return t.filter(e=>!e.acknowledged)}async _handleAccountChange(t){var s,a;const e=(s=t.ownerAddress)==null?void 0:s.toLowerCase();this.pendingActions=(a=t.data)==null?void 0:a.pendingActions,t.step==="IDLE"?(this.currentOwner=void 0,this.errors=[]):this.currentOwner===e?this.errors=this.addAcknowledgements(this.errors):e===this.tmpPlayer?(this.currentOwner=e,this.errors=this.addAcknowledgements(this.tmpErrors)):(this.currentOwner=e,this.errors=[]),this.store.set(this.errors)}subscribe(t,e){return this.store.subscribe(t,e)}}const Zt=new Jt;typeof window!="undefined"&&(window.errors=Zt);function Ne(r,t){return{from:y.getPlanetInfo(r.from.x,r.from.y),to:y.getPlanetInfo(t.x,t.y)}}class te extends U{constructor(){super({type:"SEND",step:"IDLE",pastStep:"IDLE"})}async simulateFrom(t){this.setData({from:t},{step:"PICK_DESTINATION",pastStep:"PICK_DESTINATION"})}async simulate(t){this.setData({to:t},{step:"SIMULATE"})}async cancel(){this._reset()}async back(){this.$store.pastStep==="PICK_DESTINATION"&&this.setData({to:void 0}),this.setPartial({step:this.$store.pastStep})}async acknownledgeSuccess(){this._reset()}async acknownledgeError(){this.setPartial({error:void 0})}_reset(){this.setPartial({step:"IDLE",data:void 0})}}var De=new te;class ee extends U{constructor(){super({type:"EXIT",step:"IDLE"})}async exitFrom(t){this.setData({location:t},{step:"CONNECTING"}),this.setPartial({step:"WAITING_CONFIRMATION",cancelingConfirmation:!1})}async confirm(){var d,c;const t=this.setPartial({step:"CREATING_TX"});if(!t.data)throw new Error("no flow data");let e;try{e=await h.provider.getBlock("latest")}catch(n){this.setPartial({step:"WAITING_CONFIRMATION",error:n});return}const s=t.data.location,a=L(s.x,s.y);let i;try{i=await((d=h.contracts)==null?void 0:d.OuterSpace.estimateGas.exitFor(h.address,a))}catch(n){this.setPartial({step:"WAITING_CONFIRMATION",error:n});return}const o=i.add(1e5);this.setPartial({step:"WAITING_TX"});let l;try{l=await((c=h.contracts)==null?void 0:c.OuterSpace.exitFor(h.address,a,{gasLimit:o}))}catch(n){if(n.transactionHash){l={hash:n.transactionHash};try{l=await h.provider.getTransaction(n.transactionHash)}catch{console.log("could not fetch tx, to get the nonce")}}if(!l||!l.hash){if(console.error(n),n.message&&n.message.indexOf("User denied")>=0){this.setPartial({step:"IDLE",error:void 0});return}this.setPartial({step:"WAITING_CONFIRMATION",error:n});return}}S.recordExit(s,l.hash,e.timestamp,l.nonce),this.setData({txHash:l.hash},{step:"SUCCESS"})}async cancelCancelation(){this.setPartial({cancelingConfirmation:!1})}async cancel(t=!1){t?this.setPartial({cancelingConfirmation:!0}):this._reset()}async acknownledgeSuccess(){this._reset()}async acknownledgeError(){this.setPartial({error:void 0})}_reset(){this.setPartial({step:"IDLE",data:void 0})}}var xe=new ee;class se extends U{constructor(){super({type:"TRANSFER_PLANET",step:"IDLE"})}async transfer(t){this.setData({location:t},{step:"CHOOSE_NEW_OWNER"}),this.setPartial({step:"CHOOSE_NEW_OWNER",cancelingConfirmation:!1})}async confirm(t){var c,n;const e=this.setPartial({step:"CREATING_TX"});if(!e.data)throw new Error("no flow data");let s;try{s=await h.provider.getBlock("latest")}catch(p){this.setPartial({step:"CHOOSE_NEW_OWNER",error:p});return}const a=e.data.location,i=L(a.x,a.y);let o;try{o=await((c=h.contracts)==null?void 0:c.OuterSpace.estimateGas.transferFrom(h.address,t,i))}catch(p){this.setPartial({step:"CHOOSE_NEW_OWNER",error:p});return}const l=o.add(1e5);this.setPartial({step:"WAITING_TX"});let d;try{d=await((n=h.contracts)==null?void 0:n.OuterSpace.transferFrom(h.address,t,i,{gasLimit:l}))}catch(p){if(console.error(p),p.message&&p.message.indexOf("User denied")>=0){this.setPartial({step:"IDLE",error:void 0});return}this.setPartial({step:"CHOOSE_NEW_OWNER",error:p});return}S.recordExit(a,d.hash,s.timestamp,d.nonce),this.setData({txHash:d.hash},{step:"SUCCESS"})}async cancelCancelation(){this.setPartial({cancelingConfirmation:!1})}async cancel(t=!1){t?this.setPartial({cancelingConfirmation:!0}):this._reset()}async acknownledgeSuccess(){this._reset()}async acknownledgeError(){this.setPartial({error:void 0})}_reset(){this.setPartial({step:"IDLE",data:void 0})}}var Re=new se;class ae extends U{constructor(){super({type:"SHOW_PLANET_DEPARTURE",step:"IDLE"})}async show(t){var e;this.setPartial({step:"LOADING",location:t});try{const s=`
query($owner: String $planet: String) {
  fleets(where: {from: $planet owner_not: $owner resolved: false} orderBy: launchTime orderDirection: desc) {
    id
    launchTime
    owner {id}
    quantity
  }
}`,a=((e=h.address)==null?void 0:e.toLowerCase())||"0x0000000000000000000000000000000000000000",i=await Ht.query(s,{variables:{owner:a,planet:t}});let o=[];i.data&&(o=i.data.fleets.map(l=>({timestamp:l.launchTime,amount:l.quantity,fleet:l.id,owner:l.owner.id}))),this.setPartial({step:"READY",location:t,departures:o})}catch(s){this.setPartial({error:s})}}async cancel(){this._reset()}async acknownledgeSuccess(){this._reset()}async acknownledgeError(){this.setPartial({error:void 0})}_reset(){this.setPartial({step:"IDLE",location:void 0})}}var Fe=new ae;class re extends U{constructor(){super({type:"MINT",step:"IDLE"})}async mint(t){this.setPartial({step:"WAITING_CONFIRMATION",cancelingConfirmation:!1}),this.setData({numTokenUnit:t})}async confirm(t){var d,c;const e=this.setPartial({step:"CREATING_TX"});if(!e.data)throw new Error("no flow data");t||(t=e.data.numTokenUnit);const s=_.from(t*10).mul("100000000000000000"),a=s.mul("1000000000000000000").div(Gt.contracts.PlayToken.linkedData.numTokensPerNativeTokenAt18Decimals);let i;try{i=await((d=h.contracts)==null?void 0:d.PlayToken.estimateGas.mint(h.address,s,{value:a}))}catch(n){this.setPartial({step:"WAITING_CONFIRMATION",error:n});return}const o=i.add(1e5);this.setPartial({step:"WAITING_TX"});let l;try{l=await((c=h.contracts)==null?void 0:c.PlayToken.mint(h.address,s,{value:a,gasLimit:o}))}catch(n){if(n.transactionHash){l={hash:n.transactionHash};try{l=await h.provider.getTransaction(n.transactionHash)}catch{console.log("could not fetch tx, to get the nonce")}}if(!l||!l.hash){if(console.error(n),n.message&&n.message.indexOf("User denied")>=0){this.setPartial({step:"IDLE",error:void 0});return}this.setPartial({step:"WAITING_CONFIRMATION",error:n});return}}this.setData({txHash:l.hash},{step:"TX_SUBMITTED"}),await h.provider.waitForTransaction(l.hash),this.setPartial({step:"SUCCESS"})}async cancelCancelation(){this.setPartial({cancelingConfirmation:!1})}async cancel(t=!1){t?this.setPartial({cancelingConfirmation:!0}):this._reset()}async acknownledgeSuccess(){this._reset()}async acknownledgeError(){this.setPartial({error:void 0})}_reset(){this.setPartial({step:"IDLE",data:void 0})}}var Me=new re;class ie{constructor(){this.stores={}}futureStatesFor(t){const e=t.location.id;let s=this.stores[e];if(!s){const a=X.planetStateFor(t);s=Dt([a,Ut],([i,o])=>{const l=o.fleets.filter(f=>f.to.location.id===t.location.id),d=[];let c,n=i;const p=st();let v=p,w=!0;for(const f of l){let u=0,E=0,P=f.from.stats.attack;f.arrivalTimeWanted>0&&c&&c.arrivalTime===f.arrivalTimeWanted&&!f.gift&&f.owner===c.fleet.owner&&(P=Math.floor((c.accumulatedAttack*c.averageAttackPower+f.quantity*f.from.stats.attack)/(f.quantity+c.accumulatedAttack)),u=c.accumulatedAttack,E+=c.accumulatedDefense);const T=f.timeLeft+p,C=T-v;v=T,(C>0||w)&&(n=y.computeFuturePlanetState(t,n,C));let R=f.quantity+u;R>Math.pow(2,32)-1&&(R=Math.pow(2,32)-1);const g=y.outcome(f.from,t,n,R,f.timeLeft,A.getPlayer(f.fleetSender),A.getPlayer(f.owner),A.getPlayer(n.owner),f.gift,f.specific,{attackPowerOverride:P,defense:E});g.gift?n.numSpaceships=g.min.numSpaceshipsLeft:(n.numSpaceships=g.min.numSpaceshipsLeft,g.min.captured&&(n.owner=f.owner)),C>0||w||g.gift?(c={arrivalTime:v,accumulatedAttack:g.gift?0:g.combat.attackerLoss,accumulatedDefense:g.gift?0:g.combat.defenderLoss,averageAttackPower:g.gift?0:P,state:n,fleet:f},d.push(c)):c&&(c.accumulatedAttack=g.gift?0:g.combat.attackerLoss,c.accumulatedDefense=g.gift?0:g.combat.defenderLoss,c.averageAttackPower=g.gift?0:P),w=!1}return d})}return s}}const ne=new ie;typeof window!="undefined"&&(window.planetFutureStates=ne);function oe(r,t){return typeof t=="undefined"?t={autoBom:!1}:typeof t!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),t={autoBom:!t}),t.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(r.type)?new Blob([String.fromCharCode(65279),r],{type:r.type}):r}function it(r,t,e){const s=new XMLHttpRequest;s.open("GET",r),s.responseType="blob",s.onload=function(){le(s.response,t,e,void 0)},s.onerror=function(){console.error("could not download file")},s.send()}function bt(r){const t=new XMLHttpRequest;t.open("HEAD",r,!1);try{t.send()}catch{}return t.status>=200&&t.status<=299}function tt(r,t){try{r.dispatchEvent(new MouseEvent("click"))}catch{const s=document.createEvent("MouseEvents");s.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),r.dispatchEvent(s)}}const Nt=typeof window!="undefined"&&window.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),ce=typeof HTMLAnchorElement!="undefined"&&"download"in HTMLAnchorElement.prototype&&!Nt?function(t,e,s){const a=window.URL||window.webkitURL,i=document.createElement("a");e=e||t.name||"download",i.download=e,i.rel="noopener",typeof t=="string"?(i.href=t,i.origin!==location.origin?bt(i.href)?it(t,e,s):tt(i,i.target="_blank"):tt(i)):(i.href=a.createObjectURL(t),setTimeout(function(){a.revokeObjectURL(i.href)},4e4),setTimeout(function(){tt(i)},0))}:typeof navigator!="undefined"&&"msSaveOrOpenBlob"in navigator?function(t,e,s){if(e=e||t.name||"download",typeof t=="string")if(bt(t))it(t,e,s);else{const a=document.createElement("a");a.href=t,a.target="_blank",setTimeout(function(){tt(a)})}else navigator.msSaveOrOpenBlob(oe(t,s),e)}:function(t,e,s,a){if(a=a||open("","_blank"),a&&(a.document.title=a.document.body.innerText="downloading..."),typeof t=="string")return it(t,e,s);const i=t.type==="application/octet-stream",o=/constructor/i.test(window.HTMLElement)||window.safari,l=/CriOS\/[\d]+/.test(navigator.userAgent);if((l||i&&o||Nt)&&typeof FileReader!="undefined"){const d=new FileReader;d.onloadend=function(){let c=d.result;c=l?c:c.replace(/^data:[^;]*;/,"data:attachment/file;"),a?a.location.href=c:location.replace(c),a=null},d.readAsDataURL(t)}else{const d=window.URL||window.webkitURL,c=d.createObjectURL(t);a?a.location=c:location.href=c,a=null,setTimeout(function(){d.revokeObjectURL(c)},4e4)}},le=ce;class de extends Y{constructor(){super({type:"RESOLVE",step:"IDLE",pastStep:"IDLE"})}showList(){this.setPartial({step:"SHOW_LIST",pastStep:"SHOW_LIST"}),Ot.unselect()}async back(){this.setPartial({step:this.$store.pastStep||"IDLE"})}async resolve(t,e,s=!1){var w,f;this.setPartial({step:"CREATING_TX",cancelingConfirmation:void 0,pastStep:e||"IDLE"});let a=t.sending.action.nonce;if(!a){console.error("NO NONCE FOUND, fetching from transaciton hash");let u;try{u=await h.provider.getTransaction(t.sending.id)}catch(E){if(E.transactionHash){u={hash:E.transactionHash};try{u=await h.provider.getTransaction(E.transactionHash)}catch{console.log("could not fetch tx, to get the nonce")}}if(!u||!u.hash){this.setPartial({step:"IDLE",error:E});return}}a=u.nonce}const i=await S.hashFleet(t.from.location,t.to.location,t.gift,t.specific,t.arrivalTimeWanted,a,t.owner,t.fleetSender,t.operator);let o;try{o=await h.provider.getBlock("latest")}catch(u){this.setPartial({step:"IDLE",error:u});return}Pt||It(o.timestamp);const l=i.secretHash,d=Math.pow(t.to.location.globalX-t.from.location.globalX,2)+Math.pow(t.to.location.globalY-t.from.location.globalY,2),c=Math.floor(Math.sqrt(d));console.log({fleetData:i,secretHash:l,distance:c,fleet:t});const n=void 0;let p;if(s)p=_.from(1e6);else try{p=await((w=h.contracts)==null?void 0:w.OuterSpace.estimateGas.resolveFleet(i.fleetId,{from:L(t.from.location.x,t.from.location.y),to:L(t.to.location.x,t.to.location.y),distance:c,arrivalTimeWanted:t.arrivalTimeWanted,secret:l,gift:t.gift,specific:t.specific,fleetSender:t.fleetSender||t.owner,operator:t.operator||t.owner}))}catch(u){this.setPartial({error:u,step:this.$store.pastStep||"IDLE"});return}const v=p.add(2e5);this.setPartial({step:"WAITING_TX"});try{const u=await((f=h.contracts)==null?void 0:f.OuterSpace.resolveFleet(i.fleetId,{from:L(t.from.location.x,t.from.location.y),to:L(t.to.location.x,t.to.location.y),distance:c,arrivalTimeWanted:t.arrivalTimeWanted,secret:l,gift:t.gift,specific:t.specific,fleetSender:t.fleetSender||t.owner,operator:t.operator||t.owner},{gasPrice:n,gasLimit:v}));S.recordFleetResolvingTxhash(i.fleetId,t.txHash,u.hash,t.to.location,o.timestamp,u.nonce,!1),this.setPartial({step:"SUCCESS"})}catch(u){if(console.error(u),u.message&&u.message.indexOf("User denied")>=0){this.setPartial({step:this.$store.pastStep||"IDLE",error:void 0});return}this.setPartial({error:u,step:this.$store.pastStep||"IDLE"});return}this.setPartial({error:void 0,step:this.$store.pastStep||"IDLE"})}async cancelCancelation(){this.setPartial({cancelingConfirmation:!1})}async cancel(t=!1){t?this.setPartial({cancelingConfirmation:!0}):this._reset()}async acknownledgeSuccess(){this._reset()}async acknownledgeError(){this.setPartial({error:void 0})}_reset(){this.setPartial({step:"IDLE"})}}var Ue=new de;class he extends Y{constructor(t,e){super({inUrl:!!Q.tokenClaim,state:"Loading"});this.wallet=t,this.chain=e,this.wallet.subscribe(()=>{this.onConnection()}),this.chain.subscribe(()=>{this.onConnection()})}onConnection(){h.chain&&h.chain.state==="Ready"&&this.check()}acknowledgeError(){this.setPartial({error:void 0})}getClaimtWallet(){return new xt(Q.tokenClaim)}clearURL(){delete Q.tokenClaim,Wt(Q),this.setPartial({inUrl:!1})}async check(){if(!this.$store.inUrl)return;if(!h.provider)throw new Error("no wallet.provider");if(!h.chain.contracts)throw new Error("no wallet.chain.contracts");let t;try{t=this.getClaimtWallet()}catch(a){this.setPartial({error:b(a)});return}(await h.chain.contracts.FreePlayToken.balanceOf(t.address)).eq(0)?this.setPartial({state:"AlreadyClaimed"}):this.setPartial({state:"Available"})}async claim(){var l;if(!h.provider)throw new Error("no wallet.provider");if(!h.chain.contracts)throw new Error("no wallet.chain.contracts");this.setPartial({state:"SettingUpClaim"});const t=this.getClaimtWallet().connect(h.provider),e=h.chain.contracts.FreePlayToken.connect(t);let s,a,i,o;try{s=await h.provider.getBalance(t.address),a=await e.balanceOf(t.address),a.eq(0),i=await h.provider.getTransactionCount(t.address,"latest"),o=await e.estimateGas.transferAlongWithETH(h.address,a,{value:1,nonce:i})}catch(d){this.setPartial({state:"Available",error:b(d)})}if(((l=h.selected)==null?void 0:l.toLowerCase())==="portis"){console.log("PORTIS bug, use alternative provider");let d=h.fallbackProvider;if(!d){let f="http://localhost:8545";const u=h.chain.chainId;u==="1"?f="https://mainnet.infura.io/v3/bc0bdd4eaac640278cdebc3aa91fabe4":u==="5"?f="https://goerli.infura.io/v3/bc0bdd4eaac640278cdebc3aa91fabe4":u==="4"?f="https://rinkeby.infura.io/v3/bc0bdd4eaac640278cdebc3aa91fabe4":u==="100"&&(f="https://rpc.gnosischain.com/"),d=new Rt(f)}const c=this.getClaimtWallet().connect(d),n=h.chain.contracts.FreePlayToken.connect(c),p=(await h.provider.getGasPrice()).mul(2),v=s.sub(o.mul(p));console.log({ethLeft:v.toString()});let w;try{w=await n.transferAlongWithETH(h.address,a,{value:v.toString(),nonce:i,gasPrice:p}),this.setPartial({state:"Claiming"})}catch(f){this.setPartial({state:"Available",error:b(f)}),console.error(f)}if(w){this.setPartial({txHash:w.hash});try{await w.wait(),this.setPartial({state:"Claimed"})}catch(f){this.setPartial({state:"Available",error:b(f)}),console.error(f)}}}else{const c=_.from("1000000000").mul(5),n=s.div(8).div(1e5),p=n.gte(c)?n:c,v=s.sub(o.mul(p));console.log({ethLeft:v.toString()});let w;try{w=await e.transferAlongWithETH(h.address,a,{value:v.toString(),nonce:i,maxFeePerGas:p,maxPriorityFeePerGas:c}),this.setPartial({state:"Claiming"})}catch(f){this.setPartial({state:"Available",error:b(f)}),console.error(f)}if(w){this.setPartial({txHash:w.hash});try{await w.wait(),this.setPartial({state:"Claimed"})}catch(f){this.setPartial({error:b(f)}),console.error(f)}}}}}var We=new he(h,Mt);export{At as B,Ce as a,at as b,Ot as c,De as d,zt as e,Vt as f,Zt as g,be as h,Ne as i,xe as j,Fe as k,jt as l,Ae as m,Me as n,ne as o,Re as p,le as q,Ue as r,Xt as s,We as t,ke as u,Le as v,Oe as w};
//# sourceMappingURL=tokenClaim-d54d7ab7.js.map
