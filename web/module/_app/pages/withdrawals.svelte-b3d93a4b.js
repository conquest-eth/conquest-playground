import{F as et,a5 as _,S as nt,i as st,s as at,d as m,O as T,P as W,v as ot,e as y,z as A,n as x,c as S,f as q,A as j,q as V,g as h,j as B,h as D,k as p,B as I,L as w,x as $,u as k,E as R,t as g,l as v,r as it,w as rt,m as ct,N as lt}from"../chunks/vendor-e78c39f1.js";import{P as F}from"../chunks/PanelButton-b24a8fdb.js";import{N as O}from"../chunks/NavButton-b22b61c0.js";import{W as G}from"../chunks/WalletAccess-ec429ef9.js";import{g as H,a as ut,w as b,b as Q}from"../chunks/wallet-c826be1b.js";import{A as ft}from"../chunks/base-652be6d9.js";import{S as dt}from"../chunks/subgraph-aa394bde.js";import{H as ht}from"../chunks/graphql-582eebcc.js";import{a as mt}from"../chunks/account-c0a26acd.js";import{i as pt}from"../chunks/contracts-69d01f63.js";import{b as U}from"../chunks/paths-28a87002.js";import{p as N}from"../chunks/privateWallet-7a0cfca0.js";import"../chunks/config-af7f3a10.js";import"../chunks/Modal-a8884379.js";class bt{constructor(t){this.stopAccountSubscription=void 0,this.queryStore=new ht(t,`query($first: Int! $lastId: ID! $time: BigInt! $owner: String) {
  planetExitEvents(first: $first where: {interupted: false success: false id_gt: $lastId exitTime_lt: $time owner: $owner}) {
    exitTime
    planet {id}
    stake
  }
  owner(id: $owner) {
    playTokenBalance
    freePlayTokenBalance
    tokenToWithdraw
  }
}`,H,{list:{path:"planetExitEvents"}}),this.store=et({step:"IDLE",exits:[],balaceToWithdraw:_.from(0)},this.start.bind(this))}getTime(){return ut()-pt.contracts.OuterSpace.linkedData.exitDuration}start(){return this._timeout,this.queryStore.runtimeVariables.time=""+this.getTime(),this.queryStore.runtimeVariables.owner="0x0000000000000000000000000000000000000000",this._timeout=setInterval(this.onTime.bind(this),1e3),this.stopAccountSubscription=mt.subscribe(async t=>{await this._handleAccountChange(t)}),this.unsubscribeFromQuery=this.queryStore.subscribe(this.update.bind(this)),this.stop.bind(this)}onTime(){this.queryStore.runtimeVariables.time=""+this.getTime()}stop(){this._timeout&&(clearInterval(this._timeout),this._timeout=void 0),this.stopAccountSubscription&&(this.stopAccountSubscription(),this.stopAccountSubscription=void 0),this.unsubscribeFromQuery&&(this.unsubscribeFromQuery(),this.unsubscribeFromQuery=void 0)}triggerUpdate(){return new Promise((t,e)=>{this._resolveFetch=t,this._fetch().catch(n=>e(n))})}_fetch(){if(!this.queryStore.runtimeVariables.owner||this.queryStore.runtimeVariables.owner==="0x0000000000000000000000000000000000000000"){this.store.update(t=>(t.data=t.data||{loading:!1,exits:[],balanceToWithdraw:_.from(0)},t.data.loading=!1,t.data.exits=[],t.data.balanceToWithdraw=_.from(0),t));return}return this.queryStore.fetch({blockNumber:H.chainInfo.lastBlockNumber})}async _handleAccountChange(t){var n;const e=(n=t.ownerAddress)==null?void 0:n.toLowerCase();this.queryStore.runtimeVariables.owner!==e&&(this.queryStore.runtimeVariables.owner=e,this.queryStore.runtimeVariables.owner||(this.queryStore.runtimeVariables.owner="0x0000000000000000000000000000000000000000"),this.store.update(s=>(s.data&&(s.data.loading=!0),s)),this._fetch())}_transform(t){if(!!t)return{loading:!1,exits:t.planetExitEvents,balanceToWithdraw:t.owner?_.from(t.owner.tokenToWithdraw):_.from(0)}}async update(t){const e={step:t.step,error:t.error,data:this._transform(t.data)};this.store.set(e);const n=this._resolveFetch;n&&(this._resolveFetch=void 0,n())}acknowledgeError(){return this.queryStore.acknowledgeError()}subscribe(t,e){return this.store.subscribe(t,e)}}const _t=new bt(dt);class wt extends ft{constructor(){super({state:"Idle",balance:_.from(0)});this.exits=[]}_onStart(){return this.$store.state==="Idle"&&this.setPartial({state:"Loading"}),_t.subscribe(this.onExitsQuery.bind(this))}onExitsQuery(t){if(t.data){this.exits=t.data.exits;let e=t.data.balanceToWithdraw;for(const n of t.data.exits)e=e.add(n.stake);this.setPartial({balance:e,state:"Ready"})}}async withdraw(){if(b.address&&b.contracts){const t=this.exits.map(e=>e.planet.id);await b.contracts.OuterSpace.fetchAndWithdrawFor(b.address,t)}else throw new Error(" not wallet or contracts")}stop(){this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0)}}const P=new wt,E="src/routes/withdrawals.svelte";function Y(r){let t;const e={c:function(){t=g("Back To Game")},l:function(s){t=v(s,"Back To Game")},m:function(s,o){p(s,t,o)},d:function(s){s&&h(t)}};return m("SvelteRegisterBlock",{block:e,id:Y.name,type:"slot",source:'(11:2) <NavButton label=\\"Back To Game\\" href={`${base}/`}>',ctx:r}),e}function z(r){let t,e,n;function s(f,i){return f[3].state==="Loading"?K:J}let o=s(r),a=o(r);e=new F({props:{class:"block w-max-content m-4",label:"withdraw",disabled:r[3].balance.eq(0),$$slots:{default:[X]},$$scope:{ctx:r}},$$inline:!0}),e.$on("click",r[5]);const u={c:function(){a.c(),t=x(),A(e.$$.fragment)},l:function(i){a.l(i),t=V(i),j(e.$$.fragment,i)},m:function(i,c){a.m(i,c),p(i,t,c),I(e,i,c),n=!0},p:function(i,c){o===(o=s(i))&&a?a.p(i,c):(a.d(1),a=o(i),a&&(a.c(),a.m(t.parentNode,t)));const l={};c&8&&(l.disabled=i[3].balance.eq(0)),c&64&&(l.$$scope={dirty:c,ctx:i}),e.$set(l)},i:function(i){n||($(e.$$.fragment,i),n=!0)},o:function(i){k(e.$$.fragment,i),n=!1},d:function(i){a.d(i),i&&h(t),R(e,i)}};return m("SvelteRegisterBlock",{block:u,id:z.name,type:"else",source:"(25:6) {:else}",ctx:r}),u}function M(r){let t,e;t=new F({props:{class:"w-max-content m-4",label:"connect",disabled:!r[1].available||r[2].connecting,$$slots:{default:[Z]},$$scope:{ctx:r}},$$inline:!0}),t.$on("click",r[4]);const n={c:function(){A(t.$$.fragment)},l:function(o){j(t.$$.fragment,o)},m:function(o,a){I(t,o,a),e=!0},p:function(o,a){const u={};a&6&&(u.disabled=!o[1].available||o[2].connecting),a&64&&(u.$$scope={dirty:a,ctx:o}),t.$set(u)},i:function(o){e||($(t.$$.fragment,o),e=!0)},o:function(o){k(t.$$.fragment,o),e=!1},d:function(o){R(t,o)}};return m("SvelteRegisterBlock",{block:n,id:M.name,type:"if",source:"(16:6) {#if $privateWallet.step !== 'READY'}",ctx:r}),n}function J(r){let t,e,n=r[3].balance.div("10000000000000000").toNumber()/100+"",s;const o={c:function(){t=y("p"),e=g("Amount available: "),s=g(n),this.h()},l:function(u){t=S(u,"P",{class:!0});var f=q(t);e=v(f,"Amount available: "),s=v(f,n),f.forEach(h),this.h()},h:function(){D(t,"class","m-2 text-center"),B(t,E,30,10,1120)},m:function(u,f){p(u,t,f),w(t,e),w(t,s)},p:function(u,f){f&8&&n!==(n=u[3].balance.div("10000000000000000").toNumber()/100+"")&&ct(s,n)},d:function(u){u&&h(t)}};return m("SvelteRegisterBlock",{block:o,id:J.name,type:"else",source:"(30:8) {:else}",ctx:r}),o}function K(r){let t,e;const n={c:function(){t=y("p"),e=g("Please wait..."),this.h()},l:function(o){t=S(o,"P",{});var a=q(t);e=v(a,"Please wait..."),a.forEach(h),this.h()},h:function(){B(t,E,26,10,970)},m:function(o,a){p(o,t,a),w(t,e)},p:lt,d:function(o){o&&h(t)}};return m("SvelteRegisterBlock",{block:n,id:K.name,type:"if",source:"(26:8) {#if $withdrawals.state === 'Loading'}",ctx:r}),n}function X(r){let t;const e={c:function(){t=g("withdraw")},l:function(s){t=v(s,"withdraw")},m:function(s,o){p(s,t,o)},d:function(s){s&&h(t)}};return m("SvelteRegisterBlock",{block:e,id:X.name,type:"slot",source:'(35:8) <Button           class=\\"block w-max-content m-4\\"           label=\\"withdraw\\"           disabled={$withdrawals.balance.eq(0)}           on:click={() => withdrawals.withdraw()}         >',ctx:r}),e}function Z(r){let t;const e={c:function(){t=g("Connect")},l:function(s){t=v(s,"Connect")},m:function(s,o){p(s,t,o)},d:function(s){s&&h(t)}};return m("SvelteRegisterBlock",{block:e,id:Z.name,type:"slot",source:'(17:8) <Button           class=\\"w-max-content m-4\\"           label=\\"connect\\"           disabled={!$builtin.available || $wallet.connecting}           on:click={() => privateWallet.login()}         >',ctx:r}),e}function tt(r){let t,e,n,s;const o=[M,z],a=[];function u(i,c){return i[0].step!=="READY"?0:1}e=u(r),n=a[e]=o[e](r);const f={c:function(){t=y("div"),n.c(),this.h()},l:function(c){t=S(c,"DIV",{class:!0});var l=q(t);n.l(l),l.forEach(h),this.h()},h:function(){D(t,"class","text-cyan-300 text-center"),B(t,E,14,4,579)},m:function(c,l){p(c,t,l),a[e].m(t,null),s=!0},p:function(c,l){let d=e;e=u(c),e===d?a[e].p(c,l):(it(),k(a[d],1,1,()=>{a[d]=null}),rt(),n=a[e],n?n.p(c,l):(n=a[e]=o[e](c),n.c()),$(n,1),n.m(t,null))},i:function(c){s||($(n),s=!0)},o:function(c){k(n),s=!1},d:function(c){c&&h(t),a[e].d()}};return m("SvelteRegisterBlock",{block:f,id:tt.name,type:"slot",source:"(14:2) <WalletAccess>",ctx:r}),f}function C(r){let t,e,n,s,o,a,u;e=new O({props:{label:"Back To Game",href:`${U}/`,$$slots:{default:[Y]},$$scope:{ctx:r}},$$inline:!0}),a=new G({props:{$$slots:{default:[tt]},$$scope:{ctx:r}},$$inline:!0});const f={c:function(){t=y("div"),A(e.$$.fragment),n=x(),s=y("br"),o=x(),A(a.$$.fragment),this.h()},l:function(c){t=S(c,"DIV",{class:!0});var l=q(t);j(e.$$.fragment,l),n=V(l),s=S(l,"BR",{}),o=V(l),j(a.$$.fragment,l),l.forEach(h),this.h()},h:function(){B(s,E,12,2,551),D(t,"class","w-full h-full bg-black"),B(t,E,9,0,434)},m:function(c,l){p(c,t,l),I(e,t,null),w(t,n),w(t,s),w(t,o),I(a,t,null),u=!0},p:function(c,[l]){const d={};l&64&&(d.$$scope={dirty:l,ctx:c}),e.$set(d);const L={};l&79&&(L.$$scope={dirty:l,ctx:c}),a.$set(L)},i:function(c){u||($(e.$$.fragment,c),$(a.$$.fragment,c),u=!0)},o:function(c){k(e.$$.fragment,c),k(a.$$.fragment,c),u=!1},d:function(c){c&&h(t),R(e),R(a)}};return m("SvelteRegisterBlock",{block:f,id:C.name,type:"component",source:"",ctx:r}),f}function $t(r,t,e){let n,s,o,a;T(N,"privateWallet"),W(r,N,d=>e(0,n=d)),T(Q,"builtin"),W(r,Q,d=>e(1,s=d)),T(b,"wallet"),W(r,b,d=>e(2,o=d)),T(P,"withdrawals"),W(r,P,d=>e(3,a=d));let{$$slots:u={},$$scope:f}=t;ot("Withdrawals",u,[]);const i=[];Object.keys(t).forEach(d=>{!~i.indexOf(d)&&d.slice(0,2)!=="$$"&&d!=="slot"&&console.warn(`<Withdrawals> was created with unknown prop '${d}'`)});const c=()=>N.login(),l=()=>P.withdraw();return r.$capture_state=()=>({Button:F,NavButton:O,WalletAccess:G,wallet:b,builtin:Q,withdrawals:P,base:U,privateWallet:N,$privateWallet:n,$builtin:s,$wallet:o,$withdrawals:a}),[n,s,o,a,c,l]}class Nt extends nt{constructor(t){super(t);st(this,t,$t,C,at,{}),m("SvelteRegisterComponent",{component:this,tagName:"Withdrawals",options:t,id:C.name})}}export{Nt as default};
//# sourceMappingURL=withdrawals.svelte-b3d93a4b.js.map
